---
export const prerender = true;

import BaseLayout from '@/layouts/BaseLayout.astro';
import Header from '@/components/header.astro';
import Footer from '@/components/footer.astro';
import ContactCTA from '@/components/ContactCTA.astro';
import WorkCard from '@/components/WorkCard.astro';
import { getNotionData } from '@/lib/notion';
import { downloadAndSaveImage, isNotionUrl } from '@/lib/notion-images';

// ロゴ周りに表示するテキストデータ
const meaningRaw: {
  phrase: string;
  mean: [string, ...string[]];
}[] = [
  {
    phrase: '4',
    mean: ['四季', '.mp4', '四次元', '四則演算'],
  },
  {
    phrase: 'dgdg',
    mean: ['ドラムの音'],
  },
  {
    phrase: 'deep',
    mean: ['深い', '奥行きのある'],
  },
  {
    phrase: '駄菓子',
    mean: ['多種多様', '多方面'],
  },
  {
    phrase: 'dig',
    mean: ['調べる', '発掘する'],
  },
  {
    phrase: 'digital',
    mean: ['デジタル'],
  },
  {
    phrase: 'delight',
    mean: ['喜び', '楽しみ'],
  },
  {
    phrase: 'design',
    mean: ['デザイン'],
  },
  { phrase: 'geek', mean: ['オタク'] },
];

const highlightChars = new Set(['d', 'g', '4', '駄', '菓', '子']);

// Worksデータ（FeaturedやPrivateの判定に利用）
const notionData = await getNotionData();
const works = notionData.results;

// Notion画像をダウンロードしてローカルパスに差し替え
const worksWithLocalImages = await Promise.all(
  works.map(async (work: any) => {
    const coverImage = work.properties?.Cover?.files?.[0]?.file?.url ?? '';
    if (coverImage && isNotionUrl(coverImage)) {
      const localPath = await downloadAndSaveImage(coverImage);
      work.properties = work.properties || {};
      work.properties.Cover = {
        files: [
          {
            file: {
              url: localPath,
            },
          },
        ],
      };
    }
    return work;
  }),
);

// Featuredのworksを抽出（プライベートはFeaturedに含めない）、新しい順でソートして最大8件に制限
const featuredWorks = worksWithLocalImages
  .filter((item: any) => item.properties?.Featured?.checkbox && !item.properties?.Private?.checkbox)
  .sort((a: any, b: any) => {
    const dateA = a.properties?.['Created Date']?.date?.start || '';
    const dateB = b.properties?.['Created Date']?.date?.start || '';
    // 日付が空の場合は最後に配置
    if (!dateA && !dateB) return 0;
    if (!dateA) return 1;
    if (!dateB) return -1;
    // 降順（新しい順）
    return dateB.localeCompare(dateA);
  })
  .slice(0, 8);
---

<BaseLayout
  title="dgdgdgdg"
  description="dgdgdgdg（だがし）は屋号兼ハンドルネーム。駄菓子のように色とりどりで、手に取った人が嬉しくなるものづくりを目指しています。デザイン・コーディング・映像・音楽など、デジタルとアナログを横断した制作のポートフォリオサイトです。"
  keywords="portfolio, design, web"
>
  <Fragment slot="head">
    <!-- ページ固有の追加メタタグやスクリプトをここに記述可能 -->
  </Fragment>
  <Header />
  <main>
    <section class="hero">
      <div class="hero-content">
        <img src="/images/row.svg" alt="Logo" class="hero-logo" />
        <div class="orbiting-words">
          {
            meaningRaw.map((item, index) => (
              <div class="orbit-item" data-orbit={index}>
                <span class="phrase">
                  {item.phrase
                    .split('')
                    .map((char) => (highlightChars.has(char) ? <span class="dg4">{char}</span> : <span>{char}</span>))}
                </span>
                <div class="satellites">
                  {item.mean.map((meaning) => (
                    <span class="satellite">{meaning}</span>
                  ))}
                </div>
              </div>
            ))
          }
        </div>
        <div class="scroll-indicator">
          <span class="scroll-text">SCROLL</span>
          <svg class="scroll-line" viewBox="0 0 1 60" xmlns="http://www.w3.org/2000/svg">
            <line x1="0.5" y1="0" x2="0.5" y2="60" stroke="currentColor" stroke-width="1"></line>
          </svg>
        </div>
      </div>
    </section>
    <section class="about">
      <h2 class="about-title">活動内容</h2>
      <div class="about-logo">
        <img src="/images/row.svg" alt="dgdgdgdg" />
      </div>
      <div class="about-text">
        <ul class="activity-tree">
          <li>
            Create
            <ul>
              <li>
                Design
                <ul>
                  <li>Typeface</li>
                  <li>Graphic</li>
                  <li>Motion</li>
                </ul>
              </li>
              <li>3D Printed Product</li>
              <li>Website</li>
            </ul>
          </li>
          <li>Photography</li>
          <li>Electrical Work</li>
          <li>Other momentary interests...</li>
        </ul>
        <p class="section-link-wrapper">
          <a href="/about" class="section-link">dgdgdgdgとは</a>
        </p>
      </div>
    </section>
    <section class="featured-works">
      <h2>Featured Works</h2>
      <p>ピックアップした制作実績</p>
      <p class="section-link-wrapper">
        <a href="/works" class="section-link">Works一覧ページへ</a>
      </p>
      {
        featuredWorks.length > 0 && (
          <div class="featured-grid">
            {featuredWorks.map((item: any) => {
              const workId = item.properties?.id?.rich_text?.[0]?.plain_text ?? item.id;
              return (
                <WorkCard
                  title={item.properties?.Title?.title?.[0]?.plain_text ?? 'No title'}
                  client={item.properties?.Client?.rich_text?.[0]?.plain_text ?? ''}
                  createdDate={item.properties?.['Created Date']?.date?.start ?? ''}
                  categories={item.properties?.Category?.multi_select ?? []}
                  coverImageUrl={item.properties?.Cover?.files?.[0]?.file?.url ?? ''}
                  workId={workId}
                  isPrivate={false}
                  href={`/works/article/${workId}`}
                />
              );
            })}
          </div>
        )
      }
    </section>
  </main>
  <ContactCTA />
  <Footer />
</BaseLayout>

<style lang="sass">
  main
    margin: 0
    padding: 0

  .section-link-wrapper
    margin-top: 24px

  .section-link
    display: inline-flex
    align-items: center
    gap: 8px
    padding: 8px 16px
    border-radius: 999px
    border: 1px solid currentColor
    font-size: 14px
    letter-spacing: 0.06em
    text-decoration: none
    transition: background-color 0.2s ease, color 0.2s ease

    &::after
      content: '→'
      font-size: 12px

  .about .section-link
    color: var(--c-white)
    border-color: var(--c-white)

    &:hover
      background-color: var(--c-white)
      color: var(--c-black)

  .featured-works .section-link
    color: var(--c-black)
    border-color: var(--c-black)

    &:hover
      background-color: var(--c-black)
      color: var(--c-white)

  .hero
    --orbit-scale-y: 0.15
    --counter-scale-y: 6.667
    background-color: var(--c-black)
    height: 300vh
    position: relative
    overflow: clip

  .hero-content
    position: sticky
    top: 0
    width: 100%
    height: 100vh
    display: flex
    align-items: center
    justify-content: center
    overflow: hidden
    will-change: transform, opacity

  .hero-logo
    width: 30vw
    height: auto
    position: relative
    z-index: 10

  .scroll-indicator
    position: absolute
    bottom: 40px
    left: 50%
    color: var(--c-white)
    transform: translateX(-50%)
    display: flex
    flex-direction: column
    align-items: center
    gap: 12px
    z-index: 20
    transition: opacity 0.3s ease

  .scroll-text
    color: var(--c-white)
    font-family: 'DG4 Atomic Dot', sans-serif
    font-variation-settings: 'RNDS' 0, 'slnt' 0
    font-weight: 400
    font-style: normal
    font-synthesis: none
    font-size: 12px
    letter-spacing: 0.2em
    transform: translateY(1.2px)

  .scroll-line
    width: 1px
    height: 60px
    overflow: visible
    line
      stroke-dasharray: 60 60
      animation: scroll-line-trim 2s ease-in-out infinite

  @keyframes scroll-line-trim
    0%
      stroke-dashoffset: 60
    50%
      stroke-dashoffset: 0
    100%
      stroke-dashoffset: -60

  .orbiting-words
    position: absolute
    width: 100%
    height: 100%
    top: 0
    left: 0
    pointer-events: none
    font-family: 'DG4 Atomic Dot', sans-serif
    font-variation-settings: 'RNDS' 0, 'slnt' 0
    font-weight: 400
    font-style: normal
    font-synthesis: none

  .orbit-item
    position: absolute
    top: 50%
    left: 50%
    pointer-events: all
    transform-origin: 0 0

  .phrase
    display: block
    color: var(--c-white)
    font-size: 5vw
    white-space: nowrap
    cursor: default
    transition: color 0.3s ease
    transform: translateY(0.5vw)

  .orbit-item[data-orbit="3"] .phrase
    font-family: 'Zen Kaku Gothic New', serif
    font-weight: 900
    font-size: 2.56vw
    transform: translateY(0.256vw)

  .orbit-item:hover .dg4
    color: var(--c-accent)

  .satellites
    position: absolute
    top: 50%
    left: 50%
    transform: translate(-50%, -50%)
    opacity: 0
    visibility: hidden
    transition: opacity 0.3s ease, visibility 0.3s ease
    pointer-events: none

  .orbit-item:hover .satellites
    opacity: 1
    visibility: visible

  .satellite
    position: absolute
    top: 50%
    left: 50%
    color: var(--c-gray-550)
    font-family: 'Zen Old Mincho', serif
    font-size: 16px
    white-space: nowrap
    transform-origin: center
    animation: satellite-orbit 10s linear infinite

  // 各orbit-itemの3D軌道設定（スタート位置をバラバラに）
  .orbit-item[data-orbit="0"]
    animation: orbit-3d-0 40s linear infinite
    animation-delay: 0s

  .orbit-item[data-orbit="1"]
    animation: orbit-3d-1 50s linear infinite
    animation-delay: -10s

  .orbit-item[data-orbit="2"]
    animation: orbit-3d-2 60s linear infinite
    animation-delay: -24s

  .orbit-item[data-orbit="3"]
    animation: orbit-3d-3 44s linear infinite
    animation-delay: -16s

  .orbit-item[data-orbit="4"]
    animation: orbit-3d-4 56s linear infinite
    animation-delay: -30s

  .orbit-item[data-orbit="5"]
    animation: orbit-3d-5 48s linear infinite
    animation-delay: -20s

  .orbit-item[data-orbit="6"]
    animation: orbit-3d-6 52s linear infinite
    animation-delay: -36s

  .orbit-item[data-orbit="7"]
    animation: orbit-3d-7 64s linear infinite
    animation-delay: -44s

  .orbit-item[data-orbit="8"]
    animation: orbit-3d-8 54s linear infinite
    animation-delay: -28s

  // 楕円軌道アニメーション定義（rotateZで2D回転、scaleYで文字の潰れを打ち消し）
  // リングサイズ: 17, 52, 28, 110, 35, 62, 21, 130, 85 → 半径(+5vw): 13.5, 31, 19, 60, 22.5, 36, 15.5, 70, 47.5
  // tilt: 5, -2.67, 7.33, -4, 10, -6, 3.33, -8.33, 11.67
  // 中心: ロゴ位置（画面中央）
  @keyframes orbit-3d-0
    0%
      transform: translate(-50%, -50%) scaleY(var(--orbit-scale-y)) rotate(5deg) rotate(0deg) translateX(13.5vw) rotate(0deg) rotate(-5deg) scaleY(var(--counter-scale-y))
    100%
      transform: translate(-50%, -50%) scaleY(var(--orbit-scale-y)) rotate(5deg) rotate(360deg) translateX(13.5vw) rotate(-360deg) rotate(-5deg) scaleY(var(--counter-scale-y))

  @keyframes orbit-3d-1
    0%
      transform: translate(-50%, -50%) scaleY(var(--orbit-scale-y)) rotate(-2.67deg) rotate(0deg) translateX(36vw) rotate(0deg) rotate(2.67deg) scaleY(var(--counter-scale-y))
    100%
      transform: translate(-50%, -50%) scaleY(var(--orbit-scale-y)) rotate(-2.67deg) rotate(360deg) translateX(36vw) rotate(-360deg) rotate(2.67deg) scaleY(var(--counter-scale-y))

  @keyframes orbit-3d-2
    0%
      transform: translate(-50%, -50%) scaleY(var(--orbit-scale-y)) rotate(7.33deg) rotate(0deg) translateX(19vw) rotate(0deg) rotate(-7.33deg) scaleY(var(--counter-scale-y))
    100%
      transform: translate(-50%, -50%) scaleY(var(--orbit-scale-y)) rotate(7.33deg) rotate(360deg) translateX(19vw) rotate(-360deg) rotate(-7.33deg) scaleY(var(--counter-scale-y))

  @keyframes orbit-3d-3
    0%
      transform: translate(-50%, -50%) scaleY(var(--orbit-scale-y)) rotate(-4deg) rotate(0deg) translateX(60vw) rotate(0deg) rotate(4deg) scaleY(var(--counter-scale-y))
    100%
      transform: translate(-50%, -50%) scaleY(var(--orbit-scale-y)) rotate(-4deg) rotate(360deg) translateX(60vw) rotate(-360deg) rotate(4deg) scaleY(var(--counter-scale-y))

  @keyframes orbit-3d-4
    0%
      transform: translate(-50%, -50%) scaleY(var(--orbit-scale-y)) rotate(10deg) rotate(0deg) translateX(22.5vw) rotate(0deg) rotate(-10deg) scaleY(var(--counter-scale-y))
    100%
      transform: translate(-50%, -50%) scaleY(var(--orbit-scale-y)) rotate(10deg) rotate(360deg) translateX(22.5vw) rotate(-360deg) rotate(-10deg) scaleY(var(--counter-scale-y))

  @keyframes orbit-3d-5
    0%
      transform: translate(-50%, -50%) scaleY(var(--orbit-scale-y)) rotate(-6deg) rotate(0deg) translateX(36vw) rotate(0deg) rotate(6deg) scaleY(var(--counter-scale-y))
    100%
      transform: translate(-50%, -50%) scaleY(var(--orbit-scale-y)) rotate(-6deg) rotate(360deg) translateX(36vw) rotate(-360deg) rotate(6deg) scaleY(var(--counter-scale-y))

  @keyframes orbit-3d-6
    0%
      transform: translate(-50%, -50%) scaleY(var(--orbit-scale-y)) rotate(3.33deg) rotate(0deg) translateX(15.5vw) rotate(0deg) rotate(-3.33deg) scaleY(var(--counter-scale-y))
    100%
      transform: translate(-50%, -50%) scaleY(var(--orbit-scale-y)) rotate(3.33deg) rotate(360deg) translateX(15.5vw) rotate(-360deg) rotate(-3.33deg) scaleY(var(--counter-scale-y))

  @keyframes orbit-3d-7
    0%
      transform: translate(-50%, -50%) scaleY(var(--orbit-scale-y)) rotate(-8.33deg) rotate(0deg) translateX(70vw) rotate(0deg) rotate(8.33deg) scaleY(var(--counter-scale-y))
    100%
      transform: translate(-50%, -50%) scaleY(var(--orbit-scale-y)) rotate(-8.33deg) rotate(360deg) translateX(70vw) rotate(-360deg) rotate(8.33deg) scaleY(var(--counter-scale-y))

  @keyframes orbit-3d-8
    0%
      transform: translate(-50%, -50%) scaleY(var(--orbit-scale-y)) rotate(11.67deg) rotate(0deg) translateX(47.5vw) rotate(0deg) rotate(-11.67deg) scaleY(var(--counter-scale-y))
    100%
      transform: translate(-50%, -50%) scaleY(var(--orbit-scale-y)) rotate(11.67deg) rotate(360deg) translateX(47.5vw) rotate(-360deg) rotate(-11.67deg) scaleY(var(--counter-scale-y))

  // 衛星の周回アニメーション（常に回転）
  .orbit-item[data-orbit="0"] .satellite:nth-child(1)
    animation: satellite-orbit 8s linear infinite
    animation-delay: 0s

  .orbit-item[data-orbit="0"] .satellite:nth-child(2)
    animation: satellite-orbit 8s linear infinite
    animation-delay: 2s

  .orbit-item[data-orbit="0"] .satellite:nth-child(3)
    animation: satellite-orbit 8s linear infinite
    animation-delay: 4s

  .orbit-item[data-orbit="0"] .satellite:nth-child(4)
    animation: satellite-orbit 8s linear infinite
    animation-delay: 6s

  .orbit-item[data-orbit="1"] .satellite:nth-child(1)
    animation: satellite-orbit 9s linear infinite
    animation-delay: 0s

  .orbit-item[data-orbit="2"] .satellite:nth-child(1)
    animation: satellite-orbit 10s linear infinite
    animation-delay: 0s

  .orbit-item[data-orbit="2"] .satellite:nth-child(2)
    animation: satellite-orbit 10s linear infinite
    animation-delay: 5s

  .orbit-item[data-orbit="3"] .satellite:nth-child(1)
    animation: satellite-orbit 11s linear infinite
    animation-delay: 0s

  .orbit-item[data-orbit="4"] .satellite:nth-child(1)
    animation: satellite-orbit 9.5s linear infinite
    animation-delay: 0s

  .orbit-item[data-orbit="4"] .satellite:nth-child(2)
    animation: satellite-orbit 9.5s linear infinite
    animation-delay: 4.75s

  .orbit-item[data-orbit="5"] .satellite:nth-child(1)
    animation: satellite-orbit 10.5s linear infinite
    animation-delay: 0s

  .orbit-item[data-orbit="6"] .satellite:nth-child(1)
    animation: satellite-orbit 8.5s linear infinite
    animation-delay: 0s

  .orbit-item[data-orbit="7"] .satellite:nth-child(1)
    animation: satellite-orbit 11.5s linear infinite
    animation-delay: 0s

  .orbit-item[data-orbit="8"] .satellite:nth-child(1)
    animation: satellite-orbit 10s linear infinite
    animation-delay: 0s

  @keyframes satellite-orbit
    from
      transform: translate(-50%, -50%) scaleY(var(--orbit-scale-y)) rotate(0deg) translateX(120px) rotate(0deg) scaleY(var(--counter-scale-y))
    to
      transform: translate(-50%, -50%) scaleY(var(--orbit-scale-y)) rotate(360deg) translateX(120px) rotate(-360deg) scaleY(var(--counter-scale-y))

  // 他のorbit-itemにも衛星アニメーションを適用
  .orbit-item:not([data-orbit="0"]) .satellite
    transform: translate(-50%, -50%) scaleY(var(--orbit-scale-y)) translateX(120px) scaleY(var(--counter-scale-y))

  @media (max-width: 768px)
    .scroll-text
      font-variation-settings: 'RNDS' 0, 'slnt' 0
      font-style: normal
    .orbiting-words
      font-variation-settings: 'RNDS' 0, 'slnt' 0
      font-style: normal
    .phrase
      font-size: 24px
      transform: translateY(2.4px)
      font-variation-settings: 'RNDS' 0, 'slnt' 0
      font-style: normal

    .satellite
      font-size: 14px
      font-variation-settings: 'RNDS' 0, 'slnt' 0
      font-style: normal

    @keyframes orbit-3d-0
      0%
        transform: translate(-50%, -50%) scaleY(var(--orbit-scale-y)) rotate(5deg) rotate(0deg) translateX(13.5vw) rotate(0deg) rotate(-5deg) scaleY(var(--counter-scale-y))
      100%
        transform: translate(-50%, -50%) scaleY(var(--orbit-scale-y)) rotate(5deg) rotate(360deg) translateX(13.5vw) rotate(-360deg) rotate(-5deg) scaleY(var(--counter-scale-y))

    @keyframes orbit-3d-1
      0%
        transform: translate(-50%, -50%) scaleY(var(--orbit-scale-y)) rotate(-2.67deg) rotate(0deg) translateX(36vw) rotate(0deg) rotate(2.67deg) scaleY(var(--counter-scale-y))
      100%
        transform: translate(-50%, -50%) scaleY(var(--orbit-scale-y)) rotate(-2.67deg) rotate(360deg) translateX(36vw) rotate(-360deg) rotate(2.67deg) scaleY(var(--counter-scale-y))

    @keyframes orbit-3d-2
      0%
        transform: translate(-50%, -50%) scaleY(var(--orbit-scale-y)) rotate(7.33deg) rotate(0deg) translateX(19vw) rotate(0deg) rotate(-7.33deg) scaleY(var(--counter-scale-y))
      100%
        transform: translate(-50%, -50%) scaleY(var(--orbit-scale-y)) rotate(7.33deg) rotate(360deg) translateX(19vw) rotate(-360deg) rotate(-7.33deg) scaleY(var(--counter-scale-y))

    @keyframes orbit-3d-3
      0%
        transform: translate(-50%, -50%) scaleY(var(--orbit-scale-y)) rotate(-4deg) rotate(0deg) translateX(60vw) rotate(0deg) rotate(4deg) scaleY(var(--counter-scale-y))
      100%
        transform: translate(-50%, -50%) scaleY(var(--orbit-scale-y)) rotate(-4deg) rotate(360deg) translateX(60vw) rotate(-360deg) rotate(4deg) scaleY(var(--counter-scale-y))

    @keyframes orbit-3d-4
      0%
        transform: translate(-50%, -50%) scaleY(var(--orbit-scale-y)) rotate(10deg) rotate(0deg) translateX(22.5vw) rotate(0deg) rotate(-10deg) scaleY(var(--counter-scale-y))
      100%
        transform: translate(-50%, -50%) scaleY(var(--orbit-scale-y)) rotate(10deg) rotate(360deg) translateX(22.5vw) rotate(-360deg) rotate(-10deg) scaleY(var(--counter-scale-y))

    @keyframes orbit-3d-5
      0%
        transform: translate(-50%, -50%) scaleY(var(--orbit-scale-y)) rotate(-6deg) rotate(0deg) translateX(36vw) rotate(0deg) rotate(6deg) scaleY(var(--counter-scale-y))
      100%
        transform: translate(-50%, -50%) scaleY(var(--orbit-scale-y)) rotate(-6deg) rotate(360deg) translateX(36vw) rotate(-360deg) rotate(6deg) scaleY(var(--counter-scale-y))

    @keyframes orbit-3d-6
      0%
        transform: translate(-50%, -50%) scaleY(var(--orbit-scale-y)) rotate(3.33deg) rotate(0deg) translateX(15.5vw) rotate(0deg) rotate(-3.33deg) scaleY(var(--counter-scale-y))
      100%
        transform: translate(-50%, -50%) scaleY(var(--orbit-scale-y)) rotate(3.33deg) rotate(360deg) translateX(15.5vw) rotate(-360deg) rotate(-3.33deg) scaleY(var(--counter-scale-y))

    @keyframes orbit-3d-7
      0%
        transform: translate(-50%, -50%) scaleY(var(--orbit-scale-y)) rotate(-8.33deg) rotate(0deg) translateX(70vw) rotate(0deg) rotate(8.33deg) scaleY(var(--counter-scale-y))
      100%
        transform: translate(-50%, -50%) scaleY(var(--orbit-scale-y)) rotate(-8.33deg) rotate(360deg) translateX(70vw) rotate(-360deg) rotate(8.33deg) scaleY(var(--counter-scale-y))

    @keyframes orbit-3d-8
      0%
        transform: translate(-50%, -50%) scaleY(var(--orbit-scale-y)) rotate(11.67deg) rotate(0deg) translateX(47.5vw) rotate(0deg) rotate(-11.67deg) scaleY(var(--counter-scale-y))
      100%
        transform: translate(-50%, -50%) scaleY(var(--orbit-scale-y)) rotate(11.67deg) rotate(360deg) translateX(47.5vw) rotate(-360deg) rotate(-11.67deg) scaleY(var(--counter-scale-y))

    @keyframes satellite-orbit
      from
        transform: translate(-50%, -50%) scaleY(var(--orbit-scale-y)) rotate(0deg) translateX(80px) rotate(0deg) scaleY(var(--counter-scale-y))
      to
        transform: translate(-50%, -50%) scaleY(var(--orbit-scale-y)) rotate(360deg) translateX(80px) rotate(-360deg) scaleY(var(--counter-scale-y))

  .about
    background-color: var(--c-black)
    min-height: 100vh
    display: grid
    grid-template-columns: auto auto
    grid-template-rows: auto auto
    align-items: center
    align-content: center
    justify-content: center
    justify-items: start
    position: relative
    z-index: 1
    padding: 120px 80px
    gap: 16px 80px
    margin-top: -50vh

    .about-title
      grid-column: 2
      grid-row: 1
      color: var(--c-white)
      font-size: 40px
      letter-spacing: 0.08em

    .about-logo
      grid-column: 1
      grid-row: 1 / -1
      display: flex
      align-items: center
      justify-content: center
      img
        width: 40vw
        min-width: 400px
        max-width: 600px
        height: auto

    .about-text
      grid-column: 2
      grid-row: 2
      max-width: 560px
      p
        color: var(--c-gray-400)
        font-size: 16px
        margin-top: 24px
        line-height: 2.2
        text-align: justify
        letter-spacing: 0.04em

    .activity-tree
      margin: 0
      padding: 0
      padding-left: 1.5em
      color: var(--c-gray-400)

      ul
        margin: 0
        padding: 0
        padding-left: 1.5em

      li
        font-size: 16px
        letter-spacing: 0.04em
        padding: 6px 0

    @media (max-width: 768px)
      display: flex
      flex-direction: column
      align-items: center
      padding: 80px 24px
      gap: 48px
      .about-title
        font-size: 28px
        text-align: center
        order: 1
      .about-logo
        order: 2
        img
          width: 48vw
          min-width: 300px
          max-width: 720px
      .about-text
        order: 3
        max-width: 100%
        p
          font-size: 15px
          margin-top: 20px
          line-height: 2

  .featured-works
    background-color: var(--c-white)
    min-height: 100vh
    display: flex
    flex-direction: column
    align-items: center
    justify-content: center
    padding: 80px 40px

    h2
      color: var(--c-black)
      font-size: 48px

    p
      color: var(--c-gray-650)
      font-size: 18px
      margin-top: 16px
      margin-bottom: 40px

    .featured-grid
      width: 100%
      max-width: 1200px
      display: grid
      grid-template-columns: repeat(auto-fill, minmax(260px, 1fr))
      gap: 24px
      align-items: end

    @media (max-width: 768px)
      padding: 80px 16px

      .featured-grid
        grid-template-columns: repeat(2, 1fr)
        gap: 12px
</style>

<script>
  let scrollController: AbortController | null = null;
  let layerRafIdGlobal: number | null = null;

  document.addEventListener('astro:page-load', () => {
    // 前のスクロールリスナーとレイヤー更新をクリーンアップ
    scrollController?.abort();
    scrollController = null;
    if (layerRafIdGlobal !== null) {
      cancelAnimationFrame(layerRafIdGlobal);
      layerRafIdGlobal = null;
    }

    // 衛星アニメーションの動的設定
    const orbitItems = document.querySelectorAll('.orbit-item');
    orbitItems.forEach((item) => {
      const satellites = item.querySelectorAll('.satellite');
      const satelliteCount = satellites.length;
      satellites.forEach((satellite, index) => {
        const delay = (10 / satelliteCount) * index;
        (satellite as HTMLElement).style.animationDelay = `${delay}s`;
      });
    });

    // ヘッダー非表示制御（トランジション完了まで）
    const headerInner = document.querySelector('.header-inner') as HTMLElement;

    // スクロールパララックス + ズームイン
    const hero = document.querySelector('.hero') as HTMLElement;
    const heroContent = document.querySelector('.hero-content') as HTMLElement;
    const heroLogo = document.querySelector('.hero-logo') as HTMLElement;
    const scrollIndicator = document.querySelector('.scroll-indicator') as HTMLElement;
    if (!hero || !heroContent) return;

    // レイヤー管理: orbit-itemのY中心位置に応じてz-indexを切り替え
    // .orbiting-words から transform を外したので、
    // 各 orbit-item の z-index が .hero-logo (z-index:10) と同じコンテキストで比較される
    // ロゴ中心より上（手前）→ z-index:15、下（奥）→ z-index:5
    const updateOrbitLayers = () => {
      if (!heroLogo) return;
      const logoRect = heroLogo.getBoundingClientRect();
      const logoCenterY = logoRect.top + logoRect.height / 2;

      orbitItems.forEach((item) => {
        const el = item as HTMLElement;
        const rect = el.getBoundingClientRect();
        const itemCenterY = rect.top + rect.height / 2;
        // 下半分（Y > ロゴ中心）が手前、上半分が奥
        if (itemCenterY > logoCenterY) {
          el.style.zIndex = '15';
        } else {
          el.style.zIndex = '5';
        }
      });

      layerRafIdGlobal = requestAnimationFrame(updateOrbitLayers);
    };
    layerRafIdGlobal = requestAnimationFrame(updateOrbitLayers);

    scrollController = new AbortController();
    let ticking = false;

    const onScroll = () => {
      if (ticking) return;
      ticking = true;
      requestAnimationFrame(() => {
        const heroRect = hero.getBoundingClientRect();
        const heroHeight = hero.offsetHeight;
        const viewportHeight = window.innerHeight;
        const scrollableDistance = heroHeight - viewportHeight;

        // ヒーロー内でスクロールした量（0〜scrollableDistance）
        const scrolled = Math.max(0, -heroRect.top);
        const progress = Math.min(1, scrolled / scrollableDistance);

        // ズームイン: 後半で指数的に加速
        // 0-55%: scale 1 → 1.2（ゆるやか、パララックスが主役）
        // 55-100%: scale 1.2 → 20（急加速、画面を埋め尽くす）
        let scale: number;
        if (progress < 0.55) {
          scale = 1 + (progress / 0.55) * 0.2;
        } else {
          const zoomProgress = (progress - 0.55) / 0.45;
          const eased = zoomProgress * zoomProgress * zoomProgress;
          scale = 1.2 + eased * 18.8;
        }

        heroContent.style.transform = `scale(${scale})`;

        // パララックス: scaleY 0.15 → 1.0（楕円→円の変化）
        // 開始値を下げて変化幅を大きくすることで、
        // ズーム加速中も十分なscaleY変化が残り、パララックスが継続して見える。
        const scaleY = 0.15 + progress * 0.85;
        const counterScaleY = 1 / scaleY;

        hero.style.setProperty('--orbit-scale-y', String(scaleY));
        hero.style.setProperty('--counter-scale-y', String(counterScaleY));

        // フェードアウト: 65%〜85%でopacity 1→0（黒背景だけ残す）
        let opacity: number;
        if (progress < 0.65) {
          opacity = 1;
        } else if (progress < 0.85) {
          opacity = 1 - (progress - 0.65) / 0.2;
        } else {
          opacity = 0;
        }
        heroContent.style.opacity = String(opacity);

        // スクロールインジケーターのフェードアウト
        if (scrollIndicator) {
          const indicatorOpacity = progress < 0.03 ? 1 : Math.max(0, 1 - (progress - 0.03) / 0.07);
          scrollIndicator.style.opacity = String(indicatorOpacity);
        }

        // ヘッダー表示制御: トランジション完了（progress >= 0.85）で表示
        if (headerInner) {
          if (progress >= 0.85) {
            headerInner.style.removeProperty('opacity');
            headerInner.style.removeProperty('pointer-events');
          } else {
            headerInner.style.opacity = '0';
            headerInner.style.pointerEvents = 'none';
          }
        }

        ticking = false;
      });
    };

    window.addEventListener('scroll', onScroll, { passive: true, signal: scrollController.signal });
    // 初期状態を設定
    onScroll();
  });
</script>
