---
import BaseLayout from '@/layouts/BaseLayout.astro';
import Header from '@/components/header.astro';
import Footer from '@/components/footer.astro';

// 静的パス生成（空にして生成を停止）
export async function getStaticPaths() {
  const notionData = await getNotionData();
  // Privateがtrueのものは詳細ページを生成しない
  const publicPages = notionData.results.filter((page: any) => !page.properties?.Private?.checkbox);

  return publicPages.map((page: any) => ({
    params: { id: page.properties?.id?.rich_text?.[0]?.plain_text ?? page.id },
  }));
}

// URLパラメータからidを取得
const { id } = Astro.params;

// UUID形式かどうかを判定（ハイフン付きUUID形式）
const isUuid = /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i.test(id);

// UUIDの場合はそのまま使用、カスタムIDの場合は検索してUUIDを取得
let pageUuid: string;
if (isUuid) {
  pageUuid = id;
} else {
  const pageData: any = await findPageByCustomId(id);
  pageUuid = pageData.id;
}

// ページの詳細情報とブロックを取得（再帰的に子ブロックも含む）
const page: any = await getNotionPage(pageUuid);
const blocks: any[] = await getNotionBlocksRecursive(pageUuid);

console.log(`=== Works Detail Page (ID: ${id}) ===`);
console.log('Page:', JSON.stringify(page, null, 2));
console.log('Blocks:', JSON.stringify(blocks, null, 2));

// 日付を年月のみにフォーマットする関数（表示用）
function formatDateToYearMonth(dateString: string): string {
  if (!dateString) return '';
  // YYYY-MM-DD形式からYYYY-MMに変換
  return dateString.substring(0, 7);
}

// プロパティからデータを抽出
const title = page.properties?.Title?.title?.[0]?.plain_text ?? 'No title';
const client = page.properties?.Client?.rich_text?.[0]?.plain_text ?? '';
const createdDateFull = page.properties?.['Created Date']?.date?.start ?? '';
const createdDate = formatDateToYearMonth(createdDateFull); // 表示用は年月のみ
const categories = page.properties?.Category?.multi_select ?? [];
const coverImage = page.properties?.Cover?.files?.[0]?.file?.url ?? '';
const summary = page.properties?.Summary?.rich_text?.[0]?.plain_text ?? '';

// ブロックをレンダリングするヘルパー関数（子ブロックも再帰的に処理）
function renderBlock(block: any): string {
  const { type, id, children } = block;
  const value = block[type];

  // 子ブロックのレンダリング
  const childrenHtml = children && children.length > 0 ? renderBlocks(children) : '';

  switch (type) {
    case 'paragraph':
      return `<p>${renderRichText(value.rich_text)}</p>`;
    case 'heading_1':
      return `<h1>${renderRichText(value.rich_text)}</h1>`;
    case 'heading_2':
      return `<h2>${renderRichText(value.rich_text)}</h2>`;
    case 'heading_3':
      return `<h3>${renderRichText(value.rich_text)}</h3>`;
    case 'bulleted_list_item':
      return `<li>${renderRichText(value.rich_text)}${childrenHtml}</li>`;
    case 'numbered_list_item':
      return `<li>${renderRichText(value.rich_text)}${childrenHtml}</li>`;
    case 'to_do':
      const checked = value.checked ? 'checked' : '';
      return `<li class="todo-item"><input type="checkbox" ${checked} disabled /> <span>${renderRichText(value.rich_text)}</span>${childrenHtml}</li>`;
    case 'toggle':
      return `<details class="toggle-block"><summary>${renderRichText(value.rich_text)}</summary><div class="toggle-content">${childrenHtml}</div></details>`;
    case 'child_page':
      // 子ページは表示しない
      return '';
    case 'callout':
      // コールアウトは表示しない
      return '';
    case 'quote':
      // 引用は表示しない
      return '';
    case 'code':
      return `<pre><code class="language-${value.language}">${renderRichText(value.rich_text)}</code></pre>`;
    case 'image':
      const imageUrl = value.type === 'file' ? value.file.url : value.external.url;
      const caption = value.caption ? renderRichText(value.caption) : '';
      return `<figure><img src="${imageUrl}" alt="${caption}" />${caption ? `<figcaption>${caption}</figcaption>` : ''}</figure>`;
    case 'divider':
      return '<hr />';
    case 'embed':
      // Notionのembedブロックをiframeで表示
      if (!value.url) return '';

      // URLをembed用に変換する関数
      function convertToEmbedUrl(url: string): { url: string; isTwitter: boolean } {
        try {
          const urlObj = new URL(url);

          // X (Twitter)
          if (urlObj.hostname.includes('twitter.com') || urlObj.hostname.includes('x.com')) {
            // TwitterのツイートURLを検出
            const pathParts = urlObj.pathname.split('/').filter(Boolean);
            const statusIndex = pathParts.indexOf('status');
            if (statusIndex !== -1 && pathParts[statusIndex + 1]) {
              return { url, isTwitter: true };
            }
          }

          // YouTube
          if (urlObj.hostname.includes('youtube.com') || urlObj.hostname.includes('youtu.be')) {
            let videoId = '';
            if (urlObj.hostname.includes('youtu.be')) {
              videoId = urlObj.pathname.slice(1);
            } else {
              videoId = urlObj.searchParams.get('v') || urlObj.pathname.split('/').pop() || '';
            }
            if (videoId) {
              return { url: `https://www.youtube.com/embed/${videoId}`, isTwitter: false };
            }
          }

          // Vimeo
          if (urlObj.hostname.includes('vimeo.com')) {
            const videoId = urlObj.pathname.split('/').filter(Boolean).pop();
            if (videoId) {
              return { url: `https://player.vimeo.com/video/${videoId}`, isTwitter: false };
            }
          }

          // その他のURLはそのまま使用
          return { url, isTwitter: false };
        } catch (e) {
          // URL解析に失敗した場合はそのまま返す
          return { url, isTwitter: false };
        }
      }

      const embedInfo = convertToEmbedUrl(value.url);
      const escapedUrl = embedInfo.url.replace(/"/g, '&quot;').replace(/'/g, '&#39;');

      // デバッグ用: 元のURLと変換後のURLをログ出力
      console.log('Embed URL:', { original: value.url, converted: embedInfo.url, isTwitter: embedInfo.isTwitter });

      // Twitterの場合は特別な処理
      if (embedInfo.isTwitter) {
        const twitterEscapedUrl = value.url.replace(/"/g, '&quot;').replace(/'/g, '&#39;');
        return `<div class="embed-container embed-twitter" data-embed-url="${twitterEscapedUrl}">
          <blockquote class="twitter-tweet" data-theme="light">
            <a href="${twitterEscapedUrl}"></a>
          </blockquote>
          <script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>
        </div>`;
      }

      // その他のサービスはiframeで表示
      return `<div class="embed-container" data-embed-url="${escapedUrl}">
        <iframe 
          src="${escapedUrl}" 
          loading="lazy" 
          allowfullscreen
          allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
        ></iframe>
        <div class="embed-fallback">
          <p>埋め込みコンテンツを表示できませんでした。</p>
          <a href="${escapedUrl}" target="_blank" rel="noopener noreferrer">元のページを開く</a>
        </div>
      </div>`;
    case 'table':
      // テーブルは表示しない
      return '';
    case 'table_row':
      // table_rowは親のtableブロック内で処理されるためここでは処理しない
      return '';
    case 'bookmark':
      // Notionのbookmarkブロックをリンクカードとして表示
      if (!value.url) return '';
      const bookmarkUrl = value.url.replace(/"/g, '&quot;').replace(/'/g, '&#39;');
      const bookmarkCaption = value.caption && value.caption.length > 0 ? renderRichText(value.caption) : '';
      return `<div class="bookmark-container">
        <a href="${bookmarkUrl}" target="_blank" rel="noopener noreferrer" class="bookmark-link">
          <div class="bookmark-content">
            <div class="bookmark-url">${bookmarkUrl}</div>
            ${bookmarkCaption ? `<div class="bookmark-caption">${bookmarkCaption}</div>` : ''}
          </div>
        </a>
      </div>`;
    default:
      return `<p><em>Unsupported block type: ${type}</em></p>`;
  }
}

// リッチテキストをHTMLに変換
function renderRichText(richTextArray: any[]) {
  if (!richTextArray || richTextArray.length === 0) return '';

  return richTextArray
    .map((text) => {
      let content = text.plain_text;

      if (text.annotations.bold) content = `<strong>${content}</strong>`;
      if (text.annotations.italic) content = `<em>${content}</em>`;
      if (text.annotations.strikethrough) content = `<s>${content}</s>`;
      if (text.annotations.underline) content = `<u>${content}</u>`;
      if (text.annotations.code) content = `<code>${content}</code>`;
      if (text.href) content = `<a href="${text.href}">${content}</a>`;

      return content;
    })
    .join('');
}

// ブロックをグループ化してレンダリング（リストを適切に処理）
function renderBlocks(blocks: any[]) {
  const result: string[] = [];
  let i = 0;

  while (i < blocks.length) {
    const block = blocks[i];
    const type = block.type;

    // 連続するリストアイテムをグループ化
    if (type === 'bulleted_list_item') {
      const items: string[] = [];
      while (i < blocks.length && blocks[i].type === 'bulleted_list_item') {
        items.push(renderBlock(blocks[i]));
        i++;
      }
      result.push(`<ul>${items.join('')}</ul>`);
    } else if (type === 'numbered_list_item') {
      const items: string[] = [];
      while (i < blocks.length && blocks[i].type === 'numbered_list_item') {
        items.push(renderBlock(blocks[i]));
        i++;
      }
      result.push(`<ol>${items.join('')}</ol>`);
    } else if (type === 'to_do') {
      const items: string[] = [];
      while (i < blocks.length && blocks[i].type === 'to_do') {
        items.push(renderBlock(blocks[i]));
        i++;
      }
      result.push(`<ul class="todo-list">${items.join('')}</ul>`);
    } else {
      result.push(renderBlock(block));
      i++;
    }
  }

  return result.join('');
}
---

<BaseLayout title="Works - dgdgdgdg" description="制作実績" keywords="works, portfolio, projects">
  <Fragment slot="head">
  </Fragment>
  <Header />
  <main>
    <div class="under-construction">
      <div class="uc-content">
        <span class="uc-label">Under Construction</span>
        <p class="uc-sub">準備中</p>
      </div>
    </div>
  </main>
  <Footer />
</BaseLayout>

<style lang="sass">
  main
    margin: 0
    padding: 0

  .under-construction
    min-height: 100vh
    display: flex
    align-items: center
    justify-content: center
    background-color: #0a0a0a
    background-image: repeating-linear-gradient(45deg, #0a0a0a 0px, #0a0a0a 10px, #151515 10px, #151515 20px)
    background-size: 28.28px 28.28px
    position: relative

  .uc-content
    text-align: center
    padding: 48px 64px
    background: rgba(0, 0, 0, 0.85)
    border: 1px solid rgba(255, 255, 255, 0.06)
    border-radius: 4px

  .uc-label
    display: block
    color: rgba(255, 255, 255, 0.5)
    font-family: 'DG4 Atomic Dot', sans-serif
    font-variation-settings: 'RNDS' 0
    font-size: 24px
    letter-spacing: 0.15em

      h1 {
        font-size: 2.5rem;
        margin-bottom: 1.5rem;
      }

      .work-meta {
        .meta-item {
          margin: 0.5rem 0;
          line-height: 1.6;

          strong {
            color: #666;
            margin-right: 0.5rem;
          }
        }

        .categories {
          display: inline-flex;
          flex-wrap: wrap;
          gap: 0.5rem;
          margin-left: 0.5rem;

          .category-tag {
            padding: 0.25rem 0.75rem;
            background: #e0e0e0;
            border-radius: 12px;
            font-size: 0.85rem;
          }
        }
      }
    }

    .work-content {
      line-height: 1.8;

      :global(h1),
      :global(h2),
      :global(h3) {
        margin: 2rem 0 1rem;
      }

      :global(p) {
        margin: 1rem 0;
      }

      :global(ul),
      :global(ol) {
        margin: 1rem 0;
        padding-left: 2rem;

        // ネストされたリスト
        :global(ul),
        :global(ol) {
          margin: 0.25rem 0;
        }
      }

      :global(li) {
        margin: 0.5rem 0;

        // リストアイテム内のネストされたリスト
        > :global(ul),
        > :global(ol) {
          margin-top: 0.25rem;
        }
      }

      :global(.todo-list) {
        list-style: none;
        padding-left: 0;

        // ネストされたTODOリスト
        :global(.todo-list) {
          padding-left: 2rem;
          margin: 0.25rem 0;
        }

        :global(.todo-item) {
          :global(input[type='checkbox']) {
            margin-right: 0.5rem;
            vertical-align: middle;
          }

          // TODOアイテム内のネストされたリスト
          > :global(ul),
          > :global(ol),
          > :global(.todo-list) {
            margin-top: 0.25rem;
            padding-left: 2rem;
          }
        }
      }

      :global(.toggle-block) {
        margin: 1rem 0;
        padding: 0.75rem;
        border: 1px solid #e0e0e0;
        border-radius: 4px;

        :global(summary) {
          cursor: pointer;
          font-weight: 500;
          user-select: none;

          &:hover {
            color: #0066cc;
          }
        }
      }

      :global(.toggle-content) {
        margin-top: 0.5rem;
        padding-left: 1rem;
      }

      :global(pre) {
        margin: 1.5rem 0;
        padding: 1rem;
        background: #f5f5f5;
        border-radius: 4px;
        overflow-x: auto;

        :global(code) {
          font-family: 'Courier New', monospace;
          font-size: 0.9rem;
        }
      }

      :global(code) {
        background: #f0f0f0;
        padding: 0.2rem 0.4rem;
        border-radius: 3px;
        font-family: 'Courier New', monospace;
      }

      :global(figure) {
        margin: 2rem 0;

        :global(img) {
          max-width: 100%;
          border-radius: 4px;
        }

        :global(figcaption) {
          text-align: center;
          font-size: 0.9rem;
          color: #666;
          margin-top: 0.5rem;
        }
      }

      :global(hr) {
        margin: 2rem 0;
        border: none;
        border-top: 2px solid #ddd;
      }

      :global(a) {
        color: #0066cc;
        text-decoration: none;

        &:hover {
          text-decoration: underline;
        }
      }

      :global(.embed-container) {
        position: relative;
        width: 100%;
        margin: 2rem 0;
        padding-bottom: 56.25%; // 16:9のアスペクト比
        height: 0;
        overflow: hidden;
        border-radius: 4px;
        background: #f5f5f5;

        :global(iframe) {
          position: absolute;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          border: none;
          z-index: 1;
        }

        :global(.embed-fallback) {
          position: absolute;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          display: flex;
          flex-direction: column;
          align-items: center;
          justify-content: center;
          padding: 2rem;
          text-align: center;
          z-index: 0;
          color: #666;

          a {
            margin-top: 1rem;
            color: #0066cc;
            text-decoration: none;

            &:hover {
              text-decoration: underline;
            }
          }
        }

        // iframeが読み込まれたらフォールバックを非表示
        &:has(iframe[src]:not([src=''])) {
          :global(.embed-fallback) {
            display: none;
          }
        }
      }

      // Twitter埋め込み用のスタイル
      :global(.embed-twitter) {
        padding-bottom: 0;
        height: auto;
        min-height: 200px;
        background: transparent;

        :global(blockquote.twitter-tweet) {
          margin: 0;
          padding: 1rem;
          border: 1px solid #e0e0e0;
          border-radius: 4px;
          background: #fff;
        }
      }

      // Bookmarkブロック用のスタイル
      :global(.bookmark-container) {
        margin: 2rem 0;

        :global(.bookmark-link) {
          display: block;
          padding: 1rem;
          border: 1px solid #e0e0e0;
          border-radius: 8px;
          background: #f9f9f9;
          text-decoration: none;
          color: inherit;
          transition: all 0.2s ease;

          &:hover {
            border-color: #0066cc;
            background: #f0f7ff;
            box-shadow: 0 2px 8px rgba(0, 102, 204, 0.1);
          }

          :global(.bookmark-content) {
            :global(.bookmark-url) {
              font-weight: 500;
              color: #0066cc;
              word-break: break-all;
              margin-bottom: 0.5rem;
            }

            :global(.bookmark-caption) {
              font-size: 0.9rem;
              color: #666;
              line-height: 1.5;
            }
          }
        }
      }
    }
  }

  .debug {
    margin-top: 3rem;
    padding-top: 2rem;
    border-top: 2px dashed #ddd;

    summary {
      cursor: pointer;
      padding: 0.5rem;
      background: #f5f5f5;
      border-radius: 4px;
      margin-bottom: 0.5rem;
    }

    pre {
      padding: 1rem;
      background: #f5f5f5;
      border-radius: 4px;
      overflow-x: auto;
      font-size: 0.85rem;
    }
  }
</style>
