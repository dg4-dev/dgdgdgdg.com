---
import BaseLayout from '@/layouts/BaseLayout.astro';
import Header from '@/components/header.astro';
import Footer from '@/components/footer.astro';
import { getNotionData, findPageByCustomId, getNotionPage, getNotionBlocksRecursive } from '@/lib/notion';

// 静的パス生成（空にして生成を停止）
export async function getStaticPaths() {
  const notionData = await getNotionData();
  // Privateがtrueのものは詳細ページを生成しない
  const publicPages = notionData.results.filter((page: any) => !page.properties?.Private?.checkbox);

  return publicPages.map((page: any) => ({
    params: { id: page.properties?.id?.rich_text?.[0]?.plain_text ?? page.id },
  }));
}

// URLパラメータからidを取得
const { id } = Astro.params;

if (!id) {
  return Astro.redirect('/works');
}

// UUID形式かどうかを判定（ハイフン付きUUID形式）
const isUuid = /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i.test(id);

// UUIDの場合はそのまま使用、カスタムIDの場合は検索してUUIDを取得
let pageUuid: string;
if (isUuid) {
  pageUuid = id;
} else {
  const pageData: any = await findPageByCustomId(id);
  pageUuid = pageData.id;
}

// ページの詳細情報とブロックを取得（再帰的に子ブロックも含む・ページネーション対応）
const page: any = await getNotionPage(pageUuid);
const blocks: any[] = await getNotionBlocksRecursive(pageUuid);

// ブックマークブロックにOGメタデータ（タイトル・説明・画像・ファビコン）を付与
async function getBookmarkMeta(
  url: string,
): Promise<{ title?: string; description?: string; image?: string; logo?: string } | null> {
  try {
    const res = await fetch(`https://api.microlink.io?url=${encodeURIComponent(url)}`, {
      signal: AbortSignal.timeout(8000),
      headers: { Accept: 'application/json' },
    });
    if (!res.ok) return null;
    const json = await res.json();
    const d = json?.data;
    if (!d) return null;
    return {
      title: typeof d.title === 'string' ? d.title : undefined,
      description: typeof d.description === 'string' ? d.description : undefined,
      image: typeof d.image?.url === 'string' ? d.image.url : undefined,
      logo: typeof d.logo?.url === 'string' ? d.logo.url : undefined,
    };
  } catch {
    return null;
  }
}

async function enrichBlocksWithBookmarkMeta(blockList: any[]): Promise<void> {
  for (const block of blockList) {
    if (block.type === 'bookmark' && block.bookmark?.url) {
      block._og = await getBookmarkMeta(block.bookmark.url);
      try {
        const u = new URL(block.bookmark.url);
        block._favicon = block._og?.logo ?? `https://www.google.com/s2/favicons?domain=${u.hostname}&sz=64`;
      } catch {
        block._favicon = '';
      }
    }
    if (block.children?.length) await enrichBlocksWithBookmarkMeta(block.children);
  }
}

await enrichBlocksWithBookmarkMeta(blocks);

// 日付を年月のみにフォーマットする関数（表示用）
function formatDateToYearMonth(dateString: string): string {
  if (!dateString) return '';
  // YYYY-MM-DD形式からYYYY-MMに変換
  return dateString.substring(0, 7);
}

// Notionのカテゴリー色をCSSのHEXカラーに変換する関数
function getNotionCategoryColor(colorName: string): string {
  const colorMap: Record<string, string> = {
    default: '#373530',
    gray: '#9B9A97',
    brown: '#64473A',
    red: '#E03E3E',
    orange: '#D9730D',
    yellow: '#DFAB01',
    green: '#0F7B6C',
    blue: '#0B6E99',
    purple: '#6940A5',
    pink: '#AD1A72',
  };
  return colorMap[colorName] || colorMap.default;
}

// プロパティからデータを抽出
const title = page.properties?.Title?.title?.[0]?.plain_text ?? 'No title';
const client = page.properties?.Client?.rich_text?.[0]?.plain_text ?? '';
const createdDateFull = page.properties?.['Created Date']?.date?.start ?? '';
const createdDate = formatDateToYearMonth(createdDateFull); // 表示用は年月のみ
const categories = page.properties?.Category?.multi_select ?? [];
const summary = page.properties?.Summary?.rich_text?.[0]?.plain_text ?? '';

// ブロックをレンダリングするヘルパー関数（子ブロックも再帰的に処理）
function renderBlock(block: any): string {
  const { type, id, children } = block;
  const value = block[type];

  // 子ブロックのレンダリング
  const childrenHtml = children && children.length > 0 ? renderBlocks(children) : '';

  switch (type) {
    case 'paragraph':
      return `<p>${renderRichText(value.rich_text)}</p>`;
    case 'heading_1':
      return `<h1>${renderRichText(value.rich_text)}</h1>`;
    case 'heading_2':
      return `<h2>${renderRichText(value.rich_text)}</h2>`;
    case 'heading_3':
      return `<h3>${renderRichText(value.rich_text)}</h3>`;
    case 'bulleted_list_item':
      return `<li>${renderRichText(value.rich_text)}${childrenHtml}</li>`;
    case 'numbered_list_item':
      return `<li>${renderRichText(value.rich_text)}${childrenHtml}</li>`;
    case 'to_do':
      const checked = value.checked ? 'checked' : '';
      return `<li class="todo-item"><input type="checkbox" ${checked} disabled /> <span>${renderRichText(value.rich_text)}</span>${childrenHtml}</li>`;
    case 'toggle':
      return `<details class="toggle-block"><summary>${renderRichText(value.rich_text)}</summary><div class="toggle-content">${childrenHtml}</div></details>`;
    case 'child_page':
      // 子ページは表示しない
      return '';
    case 'callout':
      // コールアウトは表示しない
      return '';
    case 'quote':
      // 引用は表示しない
      return '';
    case 'code':
      return `<pre><code class="language-${value.language}">${renderRichText(value.rich_text)}</code></pre>`;
    case 'image':
      const imageUrl = value.type === 'file' ? value.file.url : value.external.url;
      const caption = value.caption ? renderRichText(value.caption) : '';
      return `<figure><img src="${imageUrl}" alt="${caption}" />${caption ? `<figcaption>${caption}</figcaption>` : ''}</figure>`;
    case 'video':
      const videoUrl = value.type === 'file' ? value.file.url : value.external.url;
      const videoCaption = value.caption ? renderRichText(value.caption) : '';

      // YouTube/VimeoのURLを検出してiframeに変換
      function convertVideoUrl(url: string): { url: string; isEmbed: boolean } {
        try {
          const urlObj = new URL(url);

          // YouTube
          if (urlObj.hostname.includes('youtube.com') || urlObj.hostname.includes('youtu.be')) {
            let videoId = '';
            if (urlObj.hostname.includes('youtu.be')) {
              videoId = urlObj.pathname.slice(1);
            } else {
              videoId = urlObj.searchParams.get('v') || urlObj.pathname.split('/').pop() || '';
            }
            if (videoId) {
              return { url: `https://www.youtube.com/embed/${videoId}`, isEmbed: true };
            }
          }

          // Vimeo
          if (urlObj.hostname.includes('vimeo.com')) {
            const videoId = urlObj.pathname.split('/').filter(Boolean).pop();
            if (videoId) {
              return { url: `https://player.vimeo.com/video/${videoId}`, isEmbed: true };
            }
          }

          // その他のURLはvideoタグで表示
          return { url, isEmbed: false };
        } catch (e) {
          // URL解析に失敗した場合はvideoタグで表示
          return { url, isEmbed: false };
        }
      }

      const videoInfo = convertVideoUrl(videoUrl);
      const videoEscapedUrl = videoInfo.url.replace(/"/g, '&quot;').replace(/'/g, '&#39;');

      // YouTube/Vimeoの場合はiframeで表示
      if (videoInfo.isEmbed) {
        return `<figure class="video-container">
          <div class="embed-container">
            <iframe 
              src="${videoEscapedUrl}" 
              loading="lazy" 
              allowfullscreen
              allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
            ></iframe>
          </div>
          ${videoCaption ? `<figcaption>${videoCaption}</figcaption>` : ''}
        </figure>`;
      }

      // その他の場合はvideoタグで表示
      return `<figure class="video-container"><video src="${videoEscapedUrl}" controls preload="metadata"></video>${videoCaption ? `<figcaption>${videoCaption}</figcaption>` : ''}</figure>`;
    case 'divider':
      return '<hr />';
    case 'embed':
      // Notionのembedブロックをiframeで表示
      if (!value.url) return '';

      // URLをembed用に変換する関数
      function convertToEmbedUrl(url: string): { url: string; isTwitter: boolean } {
        try {
          const urlObj = new URL(url);

          // X (Twitter)
          if (urlObj.hostname.includes('twitter.com') || urlObj.hostname.includes('x.com')) {
            // TwitterのツイートURLを検出
            const pathParts = urlObj.pathname.split('/').filter(Boolean);
            const statusIndex = pathParts.indexOf('status');
            if (statusIndex !== -1 && pathParts[statusIndex + 1]) {
              return { url, isTwitter: true };
            }
          }

          // YouTube
          if (urlObj.hostname.includes('youtube.com') || urlObj.hostname.includes('youtu.be')) {
            let videoId = '';

            // youtu.be形式: https://youtu.be/VIDEO_ID
            if (urlObj.hostname.includes('youtu.be')) {
              videoId = urlObj.pathname.split('/').filter(Boolean)[0] || '';
            }
            // youtube.com形式
            else if (urlObj.hostname.includes('youtube.com')) {
              // クエリパラメータから取得: ?v=VIDEO_ID
              videoId = urlObj.searchParams.get('v') || '';

              // クエリパラメータにない場合はパスから取得
              if (!videoId) {
                const pathParts = urlObj.pathname.split('/').filter(Boolean);
                // /embed/VIDEO_ID または /v/VIDEO_ID の形式
                const embedIndex = pathParts.indexOf('embed');
                const vIndex = pathParts.indexOf('v');

                if (embedIndex !== -1 && pathParts[embedIndex + 1]) {
                  videoId = pathParts[embedIndex + 1];
                } else if (vIndex !== -1 && pathParts[vIndex + 1]) {
                  videoId = pathParts[vIndex + 1];
                } else if (pathParts.length > 0) {
                  // 最後のパスセグメントを試す
                  videoId = pathParts[pathParts.length - 1];
                }
              }
            }

            // videoIdが見つかった場合、クエリパラメータ（時間指定など）を保持
            if (videoId) {
              const timeParam = urlObj.searchParams.get('t');
              const embedUrl = timeParam
                ? `https://www.youtube.com/embed/${videoId}?start=${timeParam.replace(/[^0-9]/g, '')}`
                : `https://www.youtube.com/embed/${videoId}`;
              return { url: embedUrl, isTwitter: false };
            }
          }

          // Vimeo
          if (urlObj.hostname.includes('vimeo.com')) {
            const videoId = urlObj.pathname.split('/').filter(Boolean).pop();
            if (videoId) {
              return { url: `https://player.vimeo.com/video/${videoId}`, isTwitter: false };
            }
          }

          // その他のURLはそのまま使用
          return { url, isTwitter: false };
        } catch (e) {
          // URL解析に失敗した場合はそのまま返す
          return { url, isTwitter: false };
        }
      }

      const embedInfo = convertToEmbedUrl(value.url);
      const escapedUrl = embedInfo.url.replace(/"/g, '&quot;').replace(/'/g, '&#39;');

      // Twitterの場合は特別な処理
      if (embedInfo.isTwitter) {
        const twitterEscapedUrl = value.url.replace(/"/g, '&quot;').replace(/'/g, '&#39;');
        return `<div class="embed-container embed-twitter" data-embed-url="${twitterEscapedUrl}">
          <blockquote class="twitter-tweet" data-theme="light">
            <a href="${twitterEscapedUrl}"></a>
          </blockquote>
          <script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>
        </div>`;
      }

      // その他のサービスはiframeで表示
      return `<div class="embed-container" data-embed-url="${escapedUrl}">
        <iframe 
          src="${escapedUrl}" 
          loading="lazy" 
          allowfullscreen
          allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
        ></iframe>
        <div class="embed-fallback">
          <p>埋め込みコンテンツを表示できませんでした。</p>
          <a href="${escapedUrl}" target="_blank" rel="noopener noreferrer">元のページを開く</a>
        </div>
      </div>`;
    case 'table':
      // テーブルは表示しない
      return '';
    case 'table_row':
      // table_rowは親のtableブロック内で処理されるためここでは処理しない
      return '';
    case 'bookmark': {
      // Notionのbookmarkブロックをリンクカードとして表示（タイトル・説明・ファビコン・OG画像付き）
      if (!value.url) return '';
      const bookmarkUrl = value.url.replace(/"/g, '&quot;').replace(/'/g, '&#39;');
      const bookmarkCaption = value.caption && value.caption.length > 0 ? renderRichText(value.caption) : '';
      const og = block._og;
      const favicon = block._favicon ?? '';
      const escapeHtml = (s: string) =>
        String(s).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
      const titleText = og?.title ? escapeHtml(og.title) : bookmarkCaption || bookmarkUrl;
      const descText = og?.description ? escapeHtml(og.description) : '';
      const rawDisplay = value.url.replace(/^https?:\/\//, '');
      const displayUrl = rawDisplay.length > 50 ? rawDisplay.slice(0, 50) + '...' : rawDisplay;
      const imgUrl = og?.image ? og.image.replace(/"/g, '&quot;').replace(/'/g, '&#39;') : '';
      return `<div class="bookmark-container">
        <a href="${bookmarkUrl}" target="_blank" rel="noopener noreferrer" class="bookmark-link">
          <div class="bookmark-left">
            <div class="bookmark-title">${titleText}</div>
            ${descText ? `<div class="bookmark-description">${descText}</div>` : ''}
            <div class="bookmark-meta">
              ${favicon ? `<img class="bookmark-favicon" src="${favicon.replace(/"/g, '&quot;')}" alt="" width="16" height="16" />` : ''}
              <span class="bookmark-url">${escapeHtml(displayUrl)}</span>
            </div>
          </div>
          ${imgUrl ? `<div class="bookmark-right"><img class="bookmark-og-image" src="${imgUrl}" alt="" loading="lazy" /></div>` : ''}
        </a>
      </div>`;
    }
    default:
      return `<p><em>Unsupported block type: ${type}</em></p>`;
  }
}

// リッチテキストをHTMLに変換
function renderRichText(richTextArray: any[]) {
  if (!richTextArray || richTextArray.length === 0) return '';

  return richTextArray
    .map((text) => {
      let content = text.plain_text;

      if (text.annotations.bold) content = `<strong>${content}</strong>`;
      if (text.annotations.italic) content = `<em>${content}</em>`;
      if (text.annotations.strikethrough) content = `<s>${content}</s>`;
      if (text.annotations.underline) content = `<u>${content}</u>`;
      if (text.annotations.code) content = `<code>${content}</code>`;
      if (text.href) content = `<a href="${text.href}">${content}</a>`;

      return content;
    })
    .join('');
}

// ブロックをグループ化してレンダリング（リストを適切に処理）
function renderBlocks(blocks: any[]) {
  const result: string[] = [];
  let i = 0;

  while (i < blocks.length) {
    const block = blocks[i];
    const type = block.type;

    // 連続するリストアイテムをグループ化
    if (type === 'bulleted_list_item') {
      const items: string[] = [];
      while (i < blocks.length && blocks[i].type === 'bulleted_list_item') {
        items.push(renderBlock(blocks[i]));
        i++;
      }
      result.push(`<ul>${items.join('')}</ul>`);
    } else if (type === 'numbered_list_item') {
      const items: string[] = [];
      while (i < blocks.length && blocks[i].type === 'numbered_list_item') {
        items.push(renderBlock(blocks[i]));
        i++;
      }
      result.push(`<ol>${items.join('')}</ol>`);
    } else if (type === 'to_do') {
      const items: string[] = [];
      while (i < blocks.length && blocks[i].type === 'to_do') {
        items.push(renderBlock(blocks[i]));
        i++;
      }
      result.push(`<ul class="todo-list">${items.join('')}</ul>`);
    } else {
      result.push(renderBlock(block));
      i++;
    }
  }

  return result.join('');
}
---

<BaseLayout
  title={`${title} - Works - dgdgdgdg`}
  description={summary || '制作実績'}
  keywords="works, portfolio, projects"
>
  <Fragment slot="head"> </Fragment>
  <Header />
  <main>
    <article class="work-detail">
      <header class="work-header">
        <h1>{title}</h1>
        <div class="work-meta">
          {
            client && (
              <div class="meta-item">
                <strong>Client:</strong> {client}
              </div>
            )
          }
          {
            createdDate && (
              <div class="meta-item">
                <strong>Created Date:</strong> {createdDate}
              </div>
            )
          }
          {
            categories.length > 0 && (
              <div class="meta-item">
                <strong>Category:</strong>
                <div class="categories">
                  {categories.map((cat: any) => (
                    <span class="category-tag" style={`background-color: ${getNotionCategoryColor(cat.color)}`}>
                      {cat.name}
                    </span>
                  ))}
                </div>
              </div>
            )
          }
        </div>
      </header>
      {
        summary && (
          <div class="work-summary">
            <p>{summary}</p>
          </div>
        )
      }
      <div
        class="work-content"
        set:html={
          blocks.length > 0
            ? renderBlocks(blocks)
            : '<p class="work-content-empty">本文はまだありません。</p>'
        }
      ></div>
    </article>
  </main>
  <Footer />
</BaseLayout>

<style lang="sass">
  main
    margin: 0
    padding: 0

  .work-detail
    max-width: 900px
    margin: 0 auto
    padding: 120px 40px 80px

  .work-header
    margin-bottom: 3rem

    h1
      font-size: 2.5rem
      margin-bottom: 1.5rem
      color: #111111

    .work-meta
      .meta-item
        margin: 0.5rem 0
        line-height: 1.6
        color: #666666

        strong
          color: #333333
          margin-right: 0.5rem

      .categories
        display: inline-flex
        flex-wrap: wrap
        gap: 0.5rem
        margin-left: 0.5rem

        .category-tag
          padding: 0.125rem 0.5rem 0.25rem 0.5rem
          border-radius: 4px
          font-size: 16px
          font-family: 'Zen Kaku Gothic New', sans-serif
          font-weight: 700
          color: #ffffff
          opacity: 0.9

  .work-cover
    width: 100%
    margin-bottom: 3rem
    border-radius: 8px
    overflow: hidden

    img
      width: 100%
      height: auto
      display: block

  .work-summary
    margin-bottom: 3rem
    padding: 1.5rem
    background: #f9f9f9
    border-radius: 8px
    border-left: 4px solid #0066cc

    p
      margin: 0
      font-size: 1.1rem
      line-height: 1.8
      color: #333333

  .work-content
    line-height: 1.8
    color: #333333

    :global(.work-content-empty)
      margin: 1rem 0
      color: #666666
      font-size: 0.95rem

    :global(h1),
    :global(h2),
    :global(h3)
      margin: 2rem 0 1rem
      color: #111111

    :global(p)
      margin: 1rem 0

    :global(ul),
    :global(ol)
      margin: 1rem 0
      padding-left: 2rem

      // ネストされたリスト
      :global(ul),
      :global(ol)
        margin: 0.25rem 0

    :global(li)
      margin: 0.5rem 0

      // リストアイテム内のネストされたリスト
      > :global(ul),
      > :global(ol)
        margin-top: 0.25rem

    :global(.todo-list)
      list-style: none
      padding-left: 0

      // ネストされたTODOリスト
      :global(.todo-list)
        padding-left: 2rem
        margin: 0.25rem 0

      :global(.todo-item)
        :global(input[type='checkbox'])
          margin-right: 0.5rem
          vertical-align: middle

        // TODOアイテム内のネストされたリスト
        > :global(ul),
        > :global(ol),
        > :global(.todo-list)
          margin-top: 0.25rem
          padding-left: 2rem

    :global(.toggle-block)
      margin: 1rem 0
      padding: 0.75rem
      border: 1px solid #e0e0e0
      border-radius: 4px

      :global(summary)
        cursor: pointer
        font-weight: 500
        user-select: none

        &:hover
          color: #0066cc

    :global(.toggle-content)
      margin-top: 0.5rem
      padding-left: 1rem

    :global(pre)
      margin: 1.5rem 0
      padding: 1rem
      background: #f5f5f5
      border-radius: 4px
      overflow-x: auto

      :global(code)
        font-family: 'Courier New', monospace
        font-size: 0.9rem

    :global(code)
      background: #f0f0f0
      padding: 0.2rem 0.4rem
      border-radius: 3px
      font-family: 'Courier New', monospace

    :global(figure)
      margin: 2rem 0

      :global(img)
        max-width: 100%
        border-radius: 4px

      :global(video)
        max-width: 100%
        border-radius: 4px
        display: block

      :global(figcaption)
        text-align: center
        font-size: 0.9rem
        color: #666
        margin-top: 0.5rem

    :global(hr)
      margin: 2rem 0
      border: none
      border-top: 2px solid #ddd

    :global(a)
      color: #0066cc
      text-decoration: none

      &:hover
        text-decoration: underline

    :global(.embed-container)
      position: relative
      width: 100%
      margin: 2rem 0
      padding-bottom: 56.25% // 16:9のアスペクト比
      height: 0
      overflow: hidden
      border-radius: 4px
      background: #f5f5f5

      :global(iframe)
        position: absolute
        top: 0
        left: 0
        width: 100%
        height: 100%
        border: none
        z-index: 1

      :global(.embed-fallback)
        position: absolute
        top: 0
        left: 0
        width: 100%
        height: 100%
        display: flex
        flex-direction: column
        align-items: center
        justify-content: center
        padding: 2rem
        text-align: center
        z-index: 0
        color: #666

        a
          margin-top: 1rem
          color: #0066cc
          text-decoration: none

          &:hover
            text-decoration: underline

      // iframeが読み込まれたらフォールバックを非表示
      &:has(iframe[src]:not([src='']))
        :global(.embed-fallback)
          display: none

    // Twitter埋め込み用のスタイル
    :global(.embed-twitter)
      padding-bottom: 0
      height: auto
      min-height: 200px
      background: transparent

      :global(blockquote.twitter-tweet)
        margin: 0
        padding: 1rem
        border: 1px solid #e0e0e0
        border-radius: 4px
        background: #fff

    // Bookmarkブロック用のスタイル（タイトル・説明・ファビコン・URL・OG画像のカード）
    :global(.bookmark-container)
      margin: 2rem 0

      :global(.bookmark-link)
        display: flex
        flex-direction: row
        align-items: stretch
        min-height: 160px
        padding: 0
        border: none
        border-radius: 12px
        background: #2a2a2a
        text-decoration: none
        color: #ffffff
        transition: opacity 0.2s ease
        overflow: hidden

        &:hover
          opacity: 0.95

        :global(.bookmark-left)
          flex: 1
          min-width: 0
          padding: 1.25rem 1.5rem
          display: flex
          flex-direction: column
          justify-content: center
          gap: 0.5rem

        :global(.bookmark-title)
          font-size: 1.1rem
          font-weight: 700
          line-height: 1.4
          color: #ffffff
          display: -webkit-box
          -webkit-line-clamp: 2
          -webkit-box-orient: vertical
          overflow: hidden

        :global(.bookmark-description)
          font-size: 0.9rem
          font-weight: 400
          line-height: 1.5
          color: rgba(255, 255, 255, 0.9)
          display: -webkit-box
          -webkit-line-clamp: 2
          -webkit-box-orient: vertical
          overflow: hidden

        :global(.bookmark-meta)
          display: flex
          align-items: center
          gap: 0.5rem
          margin-top: 0.25rem

        :global(.bookmark-favicon)
          flex-shrink: 0
          width: 16px
          height: 16px
          border-radius: 2px

        :global(.bookmark-url)
          font-size: 0.85rem
          color: rgba(255, 255, 255, 0.8)
          overflow: hidden
          text-overflow: ellipsis
          white-space: nowrap

        :global(.bookmark-right)
          flex: 0 0 42%
          max-width: 280px
          min-height: 160px
          background: #1a1a1a

        :global(.bookmark-og-image)
          width: 100%
          height: 100%
          object-fit: cover
          display: block
</style>
