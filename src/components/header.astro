---
import { ArrowUpDown, Filter, LayoutGrid } from '@lucide/astro';

interface Props {
  pageName?: string;
}

const { pageName } = Astro.props;

const navItems = [
  { label: 'Works', href: '/works' },
  { label: 'About', href: '/about' },
  { label: 'Contact', href: '/contact' },
];

const pageNameMap: Record<string, string> = {
  '/': 'Top',
  '/works': 'Works',
  '/about': 'About',
  '/contact': 'Contact',
};

const pathname = Astro.url.pathname.replace(/\/$/, '') || '/';
const currentPageName = pageName ?? pageNameMap[pathname] ?? pathname.split('/').pop() ?? 'Top';
const isWorksPage = pathname === '/works';
const isWorksArticlePage = pathname.startsWith('/works/article/');
---

<header transition:animate="none">
  <div class="header-inner">
    <div class="header-bar">
      <div class="header-left">
        <a href="/" class="header-logo-link" transition:persist="header-logo">
          <img src="/images/row.svg" alt="Logo" class="header-logo" />
        </a>
        <h1 class="current-page" transition:name="current-page">{currentPageName}</h1>
      </div>
      <button
        class="hamburger"
        type="button"
        aria-label="メニューを開く"
        aria-expanded="false"
        transition:name="hamburger"
        transition:animate="none"
      >
        <span class="hamburger-line"></span>
        <span class="hamburger-line"></span>
        <span class="hamburger-line"></span>
      </button>
    </div>
    {
      isWorksArticlePage && (
        <div class="back-to-list-row">
          <a href="/works" class="back-to-list">
            作品一覧に戻る
          </a>
        </div>
      )
    }
    {
      isWorksPage && (
        <div class="works-controls-row">
          <div class="works-controls">
            <label class="works-control">
              <span class="works-control-label">
                <ArrowUpDown class="works-control-icon" size={16} />
                作成日
              </span>
              <select class="works-control-select" data-works-sort>
                <option value="date_desc">新しい順</option>
                <option value="date_asc">古い順</option>
              </select>
            </label>
            <label class="works-control">
              <span class="works-control-label">
                <Filter class="works-control-icon" size={16} />
                公開
              </span>
              <select class="works-control-select" data-works-filter>
                <option value="all">すべて</option>
                <option value="public">公開のみ</option>
                <option value="private">プライベートのみ</option>
              </select>
            </label>
            <label class="works-control">
              <span class="works-control-label">
                <LayoutGrid class="works-control-icon" size={12} />
                カテゴリ
              </span>
              <select class="works-control-select" data-works-category>
                <option value="all">すべて</option>
              </select>
            </label>
          </div>
        </div>
      )
    }
    <div class="dropdown-wrapper" aria-hidden="true">
      <nav class="dropdown">
        <ul>
          {
            navItems.map((item) => (
              <li>
                <a href={item.href} class:list={[{ current: item.href.replace(/\/$/, '') === pathname }]}>
                  {item.label}
                </a>
              </li>
            ))
          }
        </ul>
      </nav>
    </div>
  </div>
</header>

<style lang="sass">
  header
    position: fixed
    top: 0
    left: 0
    width: 100%
    z-index: 1000
    display: flex
    flex-direction: column
    align-items: center
    padding: 16px
    pointer-events: none

  .header-inner
    background: rgba(10, 10, 10, 1)
    backdrop-filter: blur(24px)
    border: 1px solid rgba(255, 255, 255, 0.08)
    border-radius: 8px
    pointer-events: all
    box-shadow: 0 4px 32px rgba(0, 0, 0, 0.4), 0 0 0 0.5px rgba(255, 255, 255, 0.04) inset

  .header-bar
    display: flex
    align-items: center
    justify-content: space-between
    gap: 24px
    padding: 10px 28px

  .header-left
    display: flex
    align-items: center
    gap: 24px

  .back-to-list
    color: rgba(255, 255, 255, 0.6)
    font-size: 14px
    letter-spacing: 0.08em
    text-decoration: none
    transition: color 0.3s ease
    white-space: nowrap
    &:hover
      color: #ffffff

  .works-controls-row
    padding: 10px 28px
    border-top: 1px solid rgba(255, 255, 255, 0.08)

  .works-controls
    display: flex
    flex-direction: row
    gap: 12px
    margin-left: 0

  .works-control
    display: flex
    flex-direction: row
    align-items: center
    gap: 8px

  .works-control-label
    display: flex
    align-items: center
    gap: 4px
    font-size: 14px
    letter-spacing: 0.12em
    text-transform: uppercase
    color: rgba(255, 255, 255, 0.6)

  .works-control-icon
    width: 12px
    height: 12px
    color: rgba(255, 255, 255, 0.6)
    flex-shrink: 0

  .works-control-select
    appearance: none
    -webkit-appearance: none
    -moz-appearance: none
    font-family: 'Zen Kaku Gothic New', sans-serif
    font-size: 14px
    padding: 2px 6px
    border-radius: 4px
    border: 1px solid rgba(255, 255, 255, 0.16)
    background: linear-gradient(to bottom, rgba(0, 0, 0, 0.7), rgba(10, 10, 10, 0.9))
    color: #f5f5f5
    cursor: pointer
    min-width: 120px
    outline: none
    &:focus
      border-color: #00d4d4
      box-shadow: 0 0 0 1px rgba(0, 212, 212, 0.4)
    option
      background: #050505
      color: #f5f5f5

  .header-logo-link
    display: flex
    align-items: center
    line-height: 0
    flex-shrink: 0
    position: relative
    &::before
      content: ''
      position: absolute
      top: -8px
      left: -8px
      right: -8px
      bottom: -8px

  .header-logo
    height: 18px
    width: auto
    opacity: 0.9
    transition: opacity 0.3s ease
    &:hover
      opacity: 1

  .current-page
    color: #00d4d4
    font-size: 16px
    font-family: 'DG4 Atomic Dot', sans-serif
    font-variation-settings: 'RNDS' 0
    font-weight: 400
    white-space: nowrap
    transform: translateY(1.6px)

  .hamburger
    display: flex
    flex-direction: column
    justify-content: center
    gap: 4px
    background: none
    border: none
    cursor: pointer
    padding: 4px
    position: relative
    &::before
      content: ''
      position: absolute
      top: -8px
      left: -8px
      right: -8px
      bottom: -8px
    .hamburger-line
      display: block
      width: 18px
      height: 1.5px
      background: rgba(255, 255, 255, 0.7)
      border-radius: 1px
      transition: transform 0.3s ease, opacity 0.3s ease
    &:hover .hamburger-line
      background: #ffffff
    &[aria-expanded="true"]
      .hamburger-line:nth-child(1)
        transform: translateY(5.5px) rotate(45deg)
      .hamburger-line:nth-child(2)
        opacity: 0
      .hamburger-line:nth-child(3)
        transform: translateY(-5.5px) rotate(-45deg)

  .dropdown-wrapper
    display: grid
    grid-template-rows: 0fr
    transition: grid-template-rows 0.3s ease
    &.open
      grid-template-rows: 1fr

  .dropdown
    overflow: hidden
    ul
      list-style: none
      margin: 0
      padding: 0 28px 12px
      display: flex
      flex-direction: column
      font-family: 'DG4 Atomic Dot', sans-serif
      font-variation-settings: 'RNDS' 0
      gap: 16px
      border-top: 1px solid rgba(255, 255, 255, 0.08)
      padding-top: 10px
      li
        a
          color: rgba(255, 255, 255, 0.6)
          text-decoration: none
          font-weight: 500
          font-size: 16px
          letter-spacing: 0.08em
          transition: color 0.3s ease
          position: relative
          display: inline-block
          transform: translateY(1.6px)
          &::before
            content: ''
            position: absolute
            top: -6px
            left: -12px
            right: -12px
            bottom: -6px
          &:hover
            color: #ffffff
          &.current
            color: #00d4d4
            font-weight: 700
            pointer-events: none

  @media (max-width: 768px)
    header
      padding: 12px

    .header-bar
      padding: 8px 20px
      gap: 16px

    .header-logo
      height: 14px

    .current-page
      font-size: 11px
      transform: translateY(1.1px)

    .back-to-list
      font-size: 12px

    .hamburger
      .hamburger-line
        width: 16px

    .dropdown
      ul
        padding: 8px 20px 10px
        gap: 12px
        li
          a
            font-size: 16px

    .works-controls-row
      padding: 8px 20px
</style>

<script>
  function initHeader() {
    const btn = document.querySelector('.hamburger');
    const wrapper = document.querySelector('.dropdown-wrapper');
    const inner = document.querySelector('.header-inner');
    if (!btn || !wrapper || !inner) return;

    function close() {
      btn!.setAttribute('aria-expanded', 'false');
      btn!.setAttribute('aria-label', 'メニューを開く');
      wrapper!.classList.remove('open');
      wrapper!.setAttribute('aria-hidden', 'true');
      inner!.classList.remove('open');
    }

    btn.addEventListener('click', () => {
      const expanded = btn.getAttribute('aria-expanded') === 'true';
      btn.setAttribute('aria-expanded', String(!expanded));
      btn.setAttribute('aria-label', expanded ? 'メニューを開く' : 'メニューを閉じる');
      wrapper.classList.toggle('open', !expanded);
      wrapper.setAttribute('aria-hidden', String(expanded));
      inner.classList.toggle('open', !expanded);
    });

    document.addEventListener('click', (e: Event) => {
      const target = e.target as Node;
      if (!inner.contains(target)) {
        close();
      }
    });
  }

  function resetHeaderVisibility() {
    const header = document.querySelector('header') as HTMLElement;
    if (!header) return;
    if (location.pathname === '/') {
      header.style.opacity = '0';
      header.style.pointerEvents = 'none';
      header.style.transform = 'translateY(-100%)';
    } else {
      header.style.removeProperty('opacity');
      header.style.removeProperty('pointer-events');
      header.style.removeProperty('transform');
    }
  }

  // header-inner の幅をスムーズにアニメーション
  let savedInnerWidth = 0;

  document.addEventListener('astro:before-swap', () => {
    const inner = document.querySelector('.header-inner') as HTMLElement;
    if (inner && location.pathname !== '/') {
      savedInnerWidth = inner.getBoundingClientRect().width;
    }
  });

  function initCategoryFilter() {
    const categorySelect = document.querySelector('[data-works-category]') as HTMLSelectElement;
    if (!categorySelect) return;

    // 既存のオプション（「すべて」）以外を削除
    while (categorySelect.children.length > 1) {
      categorySelect.removeChild(categorySelect.lastChild!);
    }

    // カテゴリデータを取得
    const categories = (window as any).__CATEGORIES_DATA__;
    if (categories && Array.isArray(categories)) {
      categories.forEach((category: string) => {
        const option = document.createElement('option');
        option.value = category;
        option.textContent = category;
        categorySelect.appendChild(option);
      });
    }
  }

  initHeader();
  initCategoryFilter();
  document.addEventListener('astro:after-swap', () => {
    resetHeaderVisibility();
    initHeader();
    initCategoryFilter();

    const inner = document.querySelector('.header-inner') as HTMLElement;
    if (!inner || !savedInnerWidth || location.pathname === '/') {
      savedInnerWidth = 0;
      return;
    }

    const newWidth = inner.getBoundingClientRect().width;
    if (Math.abs(newWidth - savedInnerWidth) < 1) {
      savedInnerWidth = 0;
      return;
    }

    inner.style.width = `${savedInnerWidth}px`;
    requestAnimationFrame(() => {
      inner.style.transition = 'width 200ms ease-out';
      inner.style.width = `${newWidth}px`;
      inner.addEventListener('transitionend', function handler() {
        inner.style.removeProperty('width');
        inner.style.removeProperty('transition');
        inner.removeEventListener('transitionend', handler);
      });
    });
    savedInnerWidth = 0;
  });
</script>
