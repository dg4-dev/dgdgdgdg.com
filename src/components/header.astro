---
import { ArrowUpDown, Filter, LayoutGrid } from '@lucide/astro';

interface Props {
  pageName?: string;
  status?: 'open' | 'limited' | 'closed' | 'unknown';
}

const { pageName, status } = Astro.props;

const navItems = [
  { label: 'Works', href: '/works' },
  { label: 'About', href: '/about' },
  { label: 'Contact', href: '/contact' },
];

const pageNameMap: Record<string, string> = {
  '/': 'Top',
  '/works': 'Works',
  '/about': 'About',
  '/contact': 'Contact',
};

const pathname = Astro.url.pathname.replace(/\/$/, '') || '/';
const currentPageName = pageName ?? pageNameMap[pathname] ?? pathname.split('/').pop() ?? 'Top';
const isWorksPage = pathname === '/works';
const isWorksArticlePage = pathname.startsWith('/works/article/');
const isContactPage = pathname === '/contact';
---

<header>
  <div class="header-inner" style={pathname === '/' ? 'opacity: 0; pointer-events: none;' : undefined}>
    <div class="header-bar">
      <div class="header-left">
        <a href="/" class="header-logo-link" transition:persist="header-logo">
          <img src="/images/row.svg" alt="Logo" class="header-logo" />
        </a>
        <h1 class="current-page" transition:name="current-page">{currentPageName}</h1>
      </div>
      <button
        class="hamburger"
        type="button"
        aria-label="メニューを開く"
        aria-expanded="false"
        transition:name="hamburger"
        transition:animate="none"
      >
        <span class="hamburger-line"></span>
        <span class="hamburger-line"></span>
        <span class="hamburger-line"></span>
      </button>
    </div>
    {
      isWorksArticlePage && (
        <div class="back-to-list-row">
          <a href="/works" class="back-to-list">
            作品一覧に戻る
          </a>
        </div>
      )
    }
    {
      isWorksPage && (
        <div class="works-controls-row">
          <div class="works-controls">
            <label class="works-control">
              <span class="works-control-label">
                <ArrowUpDown class="works-control-icon" size={16} />
                作成日
              </span>
              <select class="works-control-select" data-works-sort>
                <option value="date_desc">新しい順</option>
                <option value="date_asc">古い順</option>
              </select>
            </label>
            <label class="works-control">
              <span class="works-control-label">
                <Filter class="works-control-icon" size={16} />
                公開
              </span>
              <select class="works-control-select" data-works-filter>
                <option value="all">すべて</option>
                <option value="public">公開のみ</option>
                <option value="private">プライベートのみ</option>
              </select>
            </label>
            <label class="works-control">
              <span class="works-control-label">
                <LayoutGrid class="works-control-icon" size={12} />
                カテゴリ
              </span>
              <select class="works-control-select" data-works-category>
                <option value="all">すべて</option>
              </select>
            </label>
          </div>
        </div>
      )
    }
    {
      isContactPage && status && (
        <div class="status-row">
          <div
            class:list={[
              'status-banner',
              {
                'status-banner--open': status === 'open',
                'status-banner--limited': status === 'limited',
                'status-banner--closed': status === 'closed',
                'status-banner--unknown': status === 'unknown',
              },
            ]}
          >
            <span class="status-message">
              {status === 'open' && '現在、通常通りご依頼をお受けできます。'}
              {status === 'limited' && '現在、内容によってはお時間をいただく場合があります。'}
              {status === 'closed' && '現在、新規のご依頼受付を停止しています。'}
              {status === 'unknown' && 'ステータスを取得できませんでした（暫定: LIMITED）。'}
            </span>
          </div>
        </div>
      )
    }
    <div class="dropdown-wrapper" aria-hidden="true">
      <nav class="dropdown">
        <ul>
          {
            navItems.map((item) => (
              <li>
                <a href={item.href} class:list={[{ current: item.href.replace(/\/$/, '') === pathname }]}>
                  {item.label}
                </a>
              </li>
            ))
          }
        </ul>
      </nav>
    </div>
  </div>
</header>

<style lang="sass">
  @use '../styles/spacing' as *
  header
    position: fixed
    top: 0
    left: 0
    width: 100%
    z-index: 1000
    display: flex
    flex-direction: column
    align-items: center
    padding: space(4)
    pointer-events: none

  .header-inner
    background: var(--c-white-a60)
    backdrop-filter: blur(32px)
    -webkit-backdrop-filter: blur(32px)
    border: 1px solid var(--c-black-a8)
    border-radius: 12px
    pointer-events: all
    box-shadow: 0 10px 40px var(--c-black-a8), 0 0 0 0.6px var(--c-black-a8) inset
    transition: opacity 0.4s ease

  .header-bar
    display: flex
    align-items: center
    justify-content: space-between
    gap: space(6)
    padding: space(3) space(6)

  .header-left
    display: flex
    align-items: center
    gap: space(6)

  .back-to-list-row
    padding: space(3) space(6)
    border-top: 1px solid var(--c-black-a8)
    transition: border-color 0.3s ease

  .back-to-list
    color: var(--c-black-a60)
    font-size: var(--type-caption-size)
    line-height: var(--type-caption-line)
    letter-spacing: 0.08em
    text-decoration: none
    transition: color 0.3s ease
    white-space: nowrap
    &:hover
      color: var(--c-black)

  .works-controls-row, .status-row
    padding: space(3) space(6)
    border-top: 1px solid var(--c-black-a8)
    transition: border-color 0.3s ease

  .works-controls
    display: flex
    flex-direction: row
    gap: space(3)
    margin-left: space(0)

  .works-control
    display: flex
    flex-direction: row
    align-items: center
    gap: space(2)

  .works-control-label
    display: flex
    align-items: center
    gap: space(1)
    font-size: var(--type-caption-size)
    line-height: var(--type-caption-line)
    letter-spacing: 0.12em
    text-transform: uppercase
    color: var(--c-black-a60)

  .works-control-icon
    width: 12px
    height: 12px
    color: var(--c-black-a60)
    flex-shrink: 0

  .works-control-select
    appearance: none
    -webkit-appearance: none
    -moz-appearance: none
    font-family: var(--font-ui)
    font-size: var(--type-caption-size)
    line-height: var(--type-caption-line)
    padding: space(1) space(2)
    border-radius: 4px
    border: 1px solid var(--c-black-a8)
    background: linear-gradient(to bottom, var(--c-white), var(--c-gray-50))
    color: var(--c-black)
    cursor: pointer
    min-width: 120px
    outline: none
    transition: border-color 0.3s ease, background 0.3s ease, color 0.3s ease
    &:focus
      border-color: var(--c-accent)
      box-shadow: 0 0 0 1px var(--c-accent-a40)
    option
      background: var(--c-white)
      color: var(--c-black)

  .status-banner
    display: inline-flex
    align-items: center
    padding: space(2) space(3)
    border-radius: 4px
    font-family: var(--font-ui)

  .status-message
    font-weight: var(--type-body-weight)
    font-size: var(--type-caption-size)
    line-height: var(--type-caption-line)

  .status-banner--open
    background: var(--c-status-open-bg)
    color: var(--c-status-open)

  .status-banner--limited
    background: var(--c-status-limited-bg)
    color: var(--c-status-limited)

  .status-banner--closed
    background: var(--c-status-closed-bg)
    color: var(--c-status-closed)

  .status-banner--unknown
    background: var(--c-white-a6)
    color: var(--c-black-a80)

  .header-logo-link
    display: flex
    align-items: center
    line-height: 0
    flex-shrink: 0
    position: relative
    &::before
      content: ''
      position: absolute
      top: calc(space(2) * -1)
      left: calc(space(2) * -1)
      right: calc(space(2) * -1)
      bottom: calc(space(2) * -1)

  .header-logo
    height: 18px
    width: auto
    opacity: 0.9
    transition: opacity 0.3s ease
    &:hover
      opacity: 1

  .current-page
    color: var(--c-accent)
    font-size: var(--type-body-size)
    font-family: var(--font-display)
    font-variation-settings: 'RNDS' 0, 'slnt' 0
    font-weight: var(--type-body-weight)
    font-style: normal
    font-synthesis: none
    white-space: nowrap
    transform: translateY(1.6px)

  .hamburger
    display: flex
    flex-direction: column
    justify-content: center
    gap: space(1)
    background: none
    border: none
    cursor: pointer
    padding: space(1)
    position: relative
    &::before
      content: ''
      position: absolute
      top: calc(space(2) * -1)
      left: calc(space(2) * -1)
      right: calc(space(2) * -1)
      bottom: calc(space(2) * -1)
    .hamburger-line
      display: block
      width: 18px
      height: 1.5px
      background: var(--c-black-a60)
      border-radius: 1px
      transition: transform 0.3s ease, opacity 0.3s ease, background 0.3s ease
    &:hover .hamburger-line
      background: var(--c-accent)
    &[aria-expanded="true"]
      .hamburger-line:nth-child(1)
        transform: translateY(5.5px) rotate(45deg)
      .hamburger-line:nth-child(2)
        opacity: 0
      .hamburger-line:nth-child(3)
        transform: translateY(-5.5px) rotate(-45deg)

  .dropdown-wrapper
    display: grid
    grid-template-rows: 0fr
    transition: grid-template-rows 0.3s ease
    &.open
      grid-template-rows: 1fr

  .dropdown
    overflow: hidden
    ul
      list-style: none
      margin: space(0)
      padding: space(0) space(6) space(3)
      display: flex
      flex-direction: column
      font-family: var(--font-display)
      font-variation-settings: 'RNDS' 0, 'slnt' 0
      font-weight: var(--type-body-weight)
      font-style: normal
      font-synthesis: none
      gap: space(4)
      border-top: 1px solid var(--c-black-a8)
      padding-top: space(3)
      li
        a
          color: var(--c-black-a60)
          text-decoration: none
          font-weight: var(--type-h2-weight)
          font-size: var(--type-body-size)
          transition: color 0.3s ease
          position: relative
          display: inline-block
          transform: translateY(1.6px)
          &::before
            content: ''
            position: absolute
            top: calc(space(2) * -1)
            left: calc(space(3) * -1)
            right: calc(space(3) * -1)
            bottom: calc(space(2) * -1)
          &:hover
            color: var(--c-black)
          &.current
            color: var(--c-accent)
            font-weight: var(--type-h2-weight)
            pointer-events: none

  @media (max-width: 768px)
    header
      padding: space(3)

    .header-bar
      padding: space(2) space(5)
      gap: space(3)

    .header-logo
      height: 16px

    .current-page
      font-size: var(--type-caption-size)
      transform: translateY(1.1px)
      font-variation-settings: 'RNDS' 0, 'slnt' 0
      font-style: normal

    .back-to-list-row
      padding: space(2) space(5)

    .back-to-list
      font-size: var(--type-caption-size)

    .hamburger
      .hamburger-line
        width: 16px

    .dropdown
      ul
        padding: space(2) space(5) space(3)
        gap: space(3)
        font-variation-settings: 'RNDS' 0, 'slnt' 0
        font-style: normal
        li
          a
            font-size: 16px
            font-variation-settings: 'RNDS' 0, 'slnt' 0
            font-style: normal

    .works-controls-row, .status-row
      padding: space(2) space(5)

    .works-controls
      flex-wrap: wrap
      flex-direction: column
      width: 170px

    .works-control
      width: 100%
      gap: space(0)
      justify-content: space-between

    .works-control-label
      font-size: 12px

    .works-control-select
      min-width: unset
      width: 90px
      font-size: 12px

    .status-message
      font-size: 12px
</style>

<script>
  function setHeaderHeight() {
    const header = document.querySelector('header');
    if (!header) return;
    document.documentElement.style.setProperty('--header-height', `${header.getBoundingClientRect().height}px`);
  }

  function initHeader() {
    const btn = document.querySelector('.hamburger');
    const wrapper = document.querySelector('.dropdown-wrapper');
    const inner = document.querySelector('.header-inner');
    if (!btn || !wrapper || !inner) return;

    const DROPDOWN_DURATION_MS = 320;

    function tickHeaderHeightUntil(endTime: number) {
      setHeaderHeight();
      if (performance.now() < endTime) {
        requestAnimationFrame(() => tickHeaderHeightUntil(endTime));
      }
    }

    function close() {
      btn!.setAttribute('aria-expanded', 'false');
      btn!.setAttribute('aria-label', 'メニューを開く');
      wrapper!.classList.remove('open');
      wrapper!.setAttribute('aria-hidden', 'true');
      inner!.classList.remove('open');
      tickHeaderHeightUntil(performance.now() + DROPDOWN_DURATION_MS);
    }

    btn.addEventListener('click', () => {
      const expanded = btn.getAttribute('aria-expanded') === 'true';
      btn.setAttribute('aria-expanded', String(!expanded));
      btn.setAttribute('aria-label', expanded ? 'メニューを開く' : 'メニューを閉じる');
      wrapper.classList.toggle('open', !expanded);
      wrapper.setAttribute('aria-hidden', String(expanded));
      inner.classList.toggle('open', !expanded);
      tickHeaderHeightUntil(performance.now() + DROPDOWN_DURATION_MS);
    });

    document.addEventListener('click', (e: Event) => {
      const target = e.target as Node;
      if (!inner.contains(target)) {
        close();
      }
    });
  }

  function resetHeaderVisibility() {
    const inner = document.querySelector('.header-inner') as HTMLElement;
    if (!inner) return;
    if (location.pathname === '/') {
      inner.style.opacity = '0';
      inner.style.pointerEvents = 'none';
    } else {
      inner.style.removeProperty('opacity');
      inner.style.removeProperty('pointer-events');
    }
  }

  // header-inner の幅をスムーズにアニメーション
  let savedInnerWidth = 0;

  document.addEventListener('astro:before-swap', () => {
    const inner = document.querySelector('.header-inner') as HTMLElement;
    if (inner && location.pathname !== '/') {
      savedInnerWidth = inner.getBoundingClientRect().width;
    }
  });

  function initCategoryFilter() {
    const categorySelect = document.querySelector('[data-works-category]') as HTMLSelectElement;
    if (!categorySelect) return;

    // 既存のオプション（「すべて」）以外を削除
    while (categorySelect.children.length > 1) {
      categorySelect.removeChild(categorySelect.lastChild!);
    }

    // カテゴリデータを取得
    const categories = (window as any).__CATEGORIES_DATA__;
    if (categories && Array.isArray(categories)) {
      categories.forEach((category: string) => {
        const option = document.createElement('option');
        option.value = category;
        option.textContent = category;
        categorySelect.appendChild(option);
      });
    }
  }

  setHeaderHeight();
  const headerEl = document.querySelector('header');
  if (headerEl) {
    new ResizeObserver(setHeaderHeight).observe(headerEl);
  }
  window.addEventListener('resize', setHeaderHeight);

  initHeader();
  initCategoryFilter();

  document.addEventListener('astro:after-swap', () => {
    setHeaderHeight();
    resetHeaderVisibility();
    initHeader();
    initCategoryFilter();

    const inner = document.querySelector('.header-inner') as HTMLElement;
    if (!inner || !savedInnerWidth || location.pathname === '/') {
      savedInnerWidth = 0;
      return;
    }

    const newWidth = inner.getBoundingClientRect().width;
    if (Math.abs(newWidth - savedInnerWidth) < 1) {
      savedInnerWidth = 0;
      return;
    }

    inner.style.width = `${savedInnerWidth}px`;
    requestAnimationFrame(() => {
      inner.style.transition = 'width 200ms ease-out';
      inner.style.width = `${newWidth}px`;
      inner.addEventListener('transitionend', function handler() {
        inner.style.removeProperty('width');
        inner.style.removeProperty('transition');
        inner.removeEventListener('transitionend', handler);
      });
    });
    savedInnerWidth = 0;
  });
</script>
